<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ç‚¹ç‚¹åœˆ - é¦–é¡µ</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* é¦–é¡µç‰¹å®šæ ·å¼ */
        .header-section {
            background: white;
            padding-bottom: 8px;
        }
        
        .package-list {
            padding: 12px 16px;
        }
        
        .package-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .publisher-info {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .avatar-section {
            position: relative;
            margin-right: 12px;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .credit-badge {
            position: absolute;
            bottom: -4px;
            right: -4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border: 2px solid white;
        }
        
        .publisher-meta {
            flex: 1;
        }
        
        .nickname {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
        }
        
        .publish-time {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }
        
        .package-type-icon {
            font-size: 20px;
        }
        
        .package-content {
            margin-bottom: 12px;
        }
        
        .content-box {
            border-radius: var(--radius-md);
            padding: 12px;
            background: var(--background);
        }
        
        .content-box.link-box {
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
            border: 1px solid #fed7aa;
        }
        
        .content-box.image-box {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid #bfdbfe;
        }
        
        .link-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .link-icon {
            font-size: 20px;
        }
        
        .link-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .image-preview {
            display: flex;
            justify-content: center;
        }
        
        .image-preview img {
            max-height: 150px;
            border-radius: var(--radius-sm);
        }
        
        .package-footer {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .progress-section {
            flex: 1;
        }
        
        .progress-bar {
            height: 6px;
            background: var(--background);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 6px;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 3px;
            transition: width 0.3s;
        }
        
        .progress-text {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .progress-text .highlight {
            color: var(--primary);
            font-weight: 600;
        }
        
        .avatar-stack {
            display: flex;
            align-items: center;
        }
        
        .helper-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid white;
            margin-left: -8px;
        }
        
        .helper-avatar:first-child {
            margin-left: 0;
        }
        
        .more-badge {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--background);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: var(--text-secondary);
            border: 2px solid white;
            margin-left: -8px;
        }
        
        .help-btn {
            padding: 8px 16px;
            background: var(--primary-gradient);
            color: white;
            border-radius: 100px;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .help-btn.disabled {
            background: var(--border);
            color: var(--text-tertiary);
        }
        
        .exposure-score {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-tertiary);
        }
        
        .load-more {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- æœç´¢å’Œç­›é€‰ -->
        <div class="header-section">
            <div class="search-bar">
                <div class="search-input">
                    <span class="icon">ğŸ”</span>
                    <input type="text" placeholder="æœç´¢ç¤¼åŒ…" id="searchInput">
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="all">å…¨éƒ¨</div>
                <div class="tab" data-tab="link">é“¾æ¥</div>
                <div class="tab" data-tab="image">å›¾ç‰‡</div>
            </div>
        </div>
        
        <!-- ç¤¼åŒ…åˆ—è¡¨ -->
        <div class="package-list" id="packageList">
            <!-- åŠ¨æ€åŠ è½½ -->
        </div>
        
        <!-- åŠ è½½æ›´å¤š -->
        <div class="load-more" id="loadMore" style="display: none;">åŠ è½½æ›´å¤š</div>
        <div class="loading" id="loading" style="display: none;">
            <div class="loading-spinner"></div>
        </div>
    </div>
    
    <!-- æ‚¬æµ®å‘å¸ƒæŒ‰é’® -->
    <div class="fab" onclick="goToPublish()">+</div>
    
    <!-- åº•éƒ¨æ ‡ç­¾æ  -->
    <div class="tab-bar">
        <a href="index.html" class="tab-item active">
            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
            </svg>
            <span class="label">é¦–é¡µ</span>
        </a>
        <a href="leaderboard.html" class="tab-item">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            <span class="label">æ¦œå•</span>
        </a>
        <a href="my.html" class="tab-item">
            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
            </svg>
            <span class="label">æˆ‘çš„</span>
        </a>
    </div>
    
    <script src="js/data.js"></script>
    <script>
        // åˆå§‹åŒ–æ•°æ®
        DataManager.init()
        
        // çŠ¶æ€ç®¡ç†
        const state = {
            currentTab: 'all',
            page: 1,
            limit: 10,
            hasMore: true,
            loading: false,
            searchKeyword: ''
        }
        
        // æ ¼å¼åŒ–ç¤¼åŒ…æ•°æ®
        function formatPackage(pkg) {
            const progressPercent = (pkg.helpCount / pkg.maxHelp) * 100
            const remaining = pkg.maxHelp - pkg.helpCount
            const currentUser = DataManager.getCurrentUser()
            
            return {
                ...pkg,
                progressPercent,
                remaining,
                publishTime: Utils.formatRelativeTime(pkg.createdAt),
                canHelp: !pkg.helpers?.some(h => h.openid === currentUser._openid) && pkg.status === 'active',
                recentHelpers: (pkg.helpers || []).slice(0, 3),
                publisher: {
                    ...pkg.publisher,
                    nickname: Utils.maskNickname(pkg.publisher?.nickName || 'ç”¨æˆ·'),
                    creditLevel: pkg.publisher?.creditLevel || 'NORMAL',
                    creditBadge: Utils.getCreditLevel(pkg.publisher?.creditScore || 60).badge
                }
            }
        }
        
        // æ¸²æŸ“ç¤¼åŒ…åˆ—è¡¨
        function renderPackages() {
            const listEl = document.getElementById('packageList')
            const loadingEl = document.getElementById('loading')
            const loadMoreEl = document.getElementById('loadMore')
            
            if (state.loading && state.page === 1) {
                listEl.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>'
                return
            }
            
            const filters = {
                status: 'active',
                page: state.page,
                limit: state.limit
            }
            
            if (state.currentTab !== 'all') {
                filters.type = state.currentTab.toUpperCase()
            }
            
            const result = DataManager.getPackages(filters)
            const formattedPackages = result.list.map(formatPackage)
            
            const html = formattedPackages.map(pkg => `
                <div class="package-card" onclick="goToDetail('${pkg._id}')">
                    <div class="publisher-info">
                        <div class="avatar-section">
                            <img class="avatar" src="${pkg.publisher.avatarUrl}" alt="">
                            <div class="credit-badge" style="background: ${Utils.getCreditLevel(pkg.publisher.creditScore).color}">
                                ${pkg.publisher.creditBadge}
                            </div>
                        </div>
                        <div class="publisher-meta">
                            <div class="nickname">${pkg.publisher.nickname}</div>
                            <div class="publish-time">${pkg.publishTime}</div>
                        </div>
                        <div class="package-type-icon">
                            ${pkg.type === 'LINK' ? 'ğŸ”—' : 'ğŸ“±'}
                        </div>
                    </div>
                    
                    <div class="package-content">
                        <div class="content-box ${pkg.type === 'LINK' ? 'link-box' : 'image-box'}">
                            ${pkg.type === 'LINK' ? `
                                <div class="link-indicator">
                                    <span class="link-icon">ğŸ”—</span>
                                    <span class="link-text">å…ƒå®æŠ½å¥–é“¾æ¥</span>
                                </div>
                            ` : `
                                <div class="image-preview">
                                    <img src="${pkg.imageUrl}" alt="äºŒç»´ç ">
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <div class="package-footer">
                        <div class="progress-section">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${pkg.progressPercent}%"></div>
                            </div>
                            <div class="progress-text">
                                è¿˜å·® <span class="highlight">${pkg.remaining}äºº</span> é¢†æ»¡
                            </div>
                        </div>
                        
                        <div class="avatar-stack">
                            ${pkg.recentHelpers.map(h => `
                                <img class="helper-avatar" src="${h.avatarUrl}" alt="">
                            `).join('')}
                            ${pkg.helpCount > 3 ? `<div class="more-badge">+${pkg.helpCount - 3}</div>` : ''}
                        </div>
                        
                        <button class="help-btn ${pkg.canHelp ? '' : 'disabled'}" 
                                onclick="event.stopPropagation(); handleHelp('${pkg._id}')"
                                ${!pkg.canHelp ? 'disabled' : ''}>
                            ${pkg.canHelp ? 'å»é¢†å–' : 'å·²é¢†å–'}
                        </button>
                    </div>
                    
                    <div class="exposure-score">
                        <span>ğŸ‘</span>
                        <span>æ›å…‰å€¼: ${pkg.exposureScore}</span>
                    </div>
                </div>
            `).join('')
            
            if (state.page === 1) {
                if (formattedPackages.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ“¦</div>
                            <div class="text">æš‚æ— ç¤¼åŒ…ï¼Œå¿«å»å‘å¸ƒå§ï¼</div>
                        </div>
                    `
                } else {
                    listEl.innerHTML = html
                }
            } else {
                listEl.insertAdjacentHTML('beforeend', html)
            }
            
            state.hasMore = result.hasMore
            loadingEl.style.display = 'none'
            loadMoreEl.style.display = state.hasMore ? 'block' : 'none'
        }
        
        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tab) {
            state.currentTab = tab
            state.page = 1
            state.hasMore = true
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab)
            })
            
            renderPackages()
        }
        
        // å¸®åŠ©ç¤¼åŒ…
        async function handleHelp(packageId) {
            const result = DataManager.helpPackage(packageId)
            
            if (result.success) {
                Utils.showToast('é¢†å–æˆåŠŸï¼', 'success')
                setTimeout(() => {
                    window.location.href = `detail.html?id=${packageId}&action=help`
                }, 500)
            } else {
                Utils.showToast(result.message, 'error')
            }
        }
        
        // è·³è½¬è¯¦æƒ…
        function goToDetail(packageId) {
            window.location.href = `detail.html?id=${packageId}`
        }
        
        // è·³è½¬å‘å¸ƒé¡µ
        function goToPublish() {
            window.location.href = 'publish.html'
        }
        
        // åŠ è½½æ›´å¤š
        function loadMore() {
            if (state.hasMore && !state.loading) {
                state.page++
                renderPackages()
            }
        }
        
        // äº‹ä»¶ç›‘å¬
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab.dataset.tab))
        })
        
        document.getElementById('loadMore')?.addEventListener('click', loadMore)
        
        document.getElementById('searchInput')?.addEventListener('input', Utils.debounce((e) => {
            state.searchKeyword = e.target.value
            state.page = 1
            renderPackages()
        }, 500))
        
        // æ— é™æ»šåŠ¨
        window.addEventListener('scroll', Utils.debounce(() => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
                loadMore()
            }
        }, 200))
        
        // åˆå§‹åŒ–
        renderPackages()
    </script>
</body>
</html>