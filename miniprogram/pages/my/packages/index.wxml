<!--pages/my/packages/index.wxml-->
<view class="container">
  <!-- æ ‡ç­¾åˆ‡æ¢ -->
  <view class="tabs-section">
    <view class="tabs">
      <view class="tab {{currentTab === 'all' ? 'active' : ''}}" bindtap="switchTab" data-tab="all">
        å…¨éƒ¨
      </view>
      <view class="tab {{currentTab === 'active' ? 'active' : ''}}" bindtap="switchTab" data-tab="active">
        è¿›è¡Œä¸­
      </view>
      <view class="tab {{currentTab === 'completed' ? 'active' : ''}}" bindtap="switchTab" data-tab="completed">
        å·²é¢†æ»¡
      </view>
      <view class="tab {{currentTab === 'cancelled' ? 'active' : ''}}" bindtap="switchTab" data-tab="cancelled">
        å·²å–æ¶ˆ
      </view>
    </view>
  </view>

  <!-- ç¤¼åŒ…åˆ—è¡¨ -->
  <view class="package-list">
    <block wx:if="{{packages.length > 0}}">
      <view class="package-card" wx:for="{{packages}}" wx:key="_id">
        <!-- å¤´éƒ¨ï¼šç±»å‹å’ŒçŠ¶æ€ -->
        <view class="card-header">
          <view class="type-badge {{item.type === 'LINK' ? 'link' : 'image'}}">
            <text class="type-icon">{{item.type === 'LINK' ? 'ğŸ”—' : 'ğŸ“±'}}</text>
            <text class="type-text">{{item.type === 'LINK' ? 'é“¾æ¥' : 'å›¾ç‰‡'}}</text>
          </view>
          <view class="status-badge {{item.status}}">
            <text wx:if="{{item.status === 'active'}}">è¿›è¡Œä¸­</text>
            <text wx:if="{{item.status === 'completed'}}">å·²é¢†æ»¡</text>
            <text wx:if="{{item.status === 'cancelled'}}">å·²å–æ¶ˆ</text>
            <text wx:if="{{item.status === 'pending'}}">å®¡æ ¸ä¸­</text>
          </view>
        </view>

        <!-- å†…å®¹åŒºåŸŸ -->
        <view class="card-content" bindtap="goToDetail" data-id="{{item._id}}">
          <view wx:if="{{item.type === 'LINK'}}" class="content-preview link-preview">
            <text class="preview-text">å…ƒå®æŠ½å¥–é“¾æ¥</text>
            <text class="preview-url">{{item.giftUrl}}</text>
          </view>
          <view wx:if="{{item.type === 'IMAGE'}}" class="content-preview image-preview">
            <image src="{{item.imageUrl}}" mode="aspectFill" lazy-load />
          </view>
        </view>

        <!-- è¿›åº¦ä¿¡æ¯ -->
        <view class="progress-section">
          <view class="progress-header">
            <text class="progress-label">é¢†å–è¿›åº¦</text>
            <text class="progress-value">{{item.helpCount}}/{{item.maxHelp}}</text>
          </view>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{(item.helpCount / item.maxHelp) * 100}}%"></view>
          </view>
          <view wx:if="{{item.status === 'active'}}" class="progress-hint">
            <text>è¿˜å·® {{item.maxHelp - item.helpCount}} äººé¢†æ»¡</text>
          </view>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view wx:if="{{item.status === 'active'}}" class="action-bar">
          <button class="action-btn secondary" catchtap="showAdjustModal" data-id="{{item._id}}" data-current="{{item.helpCount}}">
            æ›´æ­£é¢†å–æ•°
          </button>
          <button class="action-btn danger" catchtap="cancelPackage" data-id="{{item._id}}">
            å–æ¶ˆåˆ†äº«
          </button>
        </view>

        <!-- æ—¶é—´ä¿¡æ¯ -->
        <view class="time-info">
          <text class="time-text">å‘å¸ƒäº {{item.createdAt}}</text>
          <text wx:if="{{item.status === 'completed'}}" class="time-text">å®Œæˆäº {{item.updatedAt}}</text>
          <text wx:if="{{item.status === 'cancelled'}}" class="time-text">å–æ¶ˆäº {{item.management?.cancelledAt}}</text>
        </view>

        <!-- æ›´æ­£å†å² -->
        <view wx:if="{{item.management?.helpCountAdjustments?.length > 0}}" class="adjustment-info">
          <view class="adjustment-item" wx:for="{{item.management.helpCountAdjustments}}" wx:key="index">
            <text class="adjustment-text">å·²æ›´æ­£: {{item.from}}â†’{{item.to}}äºº</text>
            <text class="adjustment-reason">{{item.reason}}</text>
          </view>
        </view>
      </view>
    </block>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{packages.length === 0 && !loading}}" class="empty-state">
      <text class="empty-icon">ğŸ“¦</text>
      <text class="empty-text">æš‚æ— åˆ†äº«</text>
      <text class="empty-hint">å¿«å»å‘å¸ƒç¤¼åŒ…å§ï¼</text>
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view wx:if="{{hasMore && !loading}}" class="load-more" bindtap="loadMore">
    <text>åŠ è½½æ›´å¤š</text>
  </view>
  <view wx:if="{{loading}}" class="loading">
    <view class="loading-spinner"></view>
  </view>
</view>

<!-- æ›´æ­£å¼¹çª— -->
<view wx:if="{{showAdjustModal}}" class="modal-overlay" bindtap="closeAdjustModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">æ›´æ­£é¢†å–æ•°é‡</text>
      <text class="modal-close" bindtap="closeAdjustModal">Ã—</text>
    </view>
    <view class="modal-body">
      <view class="current-info">
        <text class="info-label">å½“å‰æ˜¾ç¤ºï¼š</text>
        <text class="info-value">{{adjustCurrent}}äººå·²é¢†</text>
      </view>
      <view class="input-group">
        <text class="input-label">å®é™…å·²é¢†ï¼š</text>
        <input 
          class="adjust-input" 
          type="number" 
          value="{{adjustValue}}"
          bindinput="onAdjustInput"
          placeholder="è¾“å…¥å®é™…æ•°é‡"
        />
        <text class="input-unit">äºº</text>
      </view>
      <view class="reason-group">
        <text class="input-label">æ›´æ­£è¯´æ˜ï¼š</text>
        <textarea 
          class="reason-input" 
          value="{{adjustReason}}"
          bindinput="onReasonInput"
          placeholder="è¯·è¯´æ˜æ›´æ­£åŸå› ï¼Œå¦‚ï¼šåˆ†äº«åˆ°å¾®ä¿¡ç¾¤é¢†äº†3äºº"
          maxlength="100"
        />
      </view>
      <view class="adjust-hint">
        <text>æ›´æ­£åå‰©ä½™ {{adjustHint}} ä¸ªåé¢</text>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn secondary" bindtap="closeAdjustModal">å–æ¶ˆ</button>
      <button class="modal-btn primary" bindtap="confirmAdjust">ç¡®è®¤æ›´æ­£</button>
    </view>
  </view>
</view>